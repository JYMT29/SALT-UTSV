<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registro de Usuarios</title>
    <!-- Bootstrap CSS (opcional pero recomendado para los estilos) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .badge-admin {
        background-color: #dc3545;
        color: white;
      }
      .badge-user {
        background-color: #28a745;
        color: white;
      }
      .alert {
        display: none;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="mb-4">Registro de Usuarios</h1>

      <!-- Formulario de registro -->
      <div class="card mb-4">
        <div class="card-body">
          <form id="userForm">
            <div class="mb-3">
              <label for="matricula" class="form-label"
                >Matrícula (opcional)</label
              >
              <input type="text" class="form-control" id="matricula" />
            </div>
            <div class="mb-3">
              <label for="nombre" class="form-label">Nombre*</label>
              <input type="text" class="form-control" id="nombre" required />
            </div>
            <div class="mb-3">
              <label for="contrasena" class="form-label">Contraseña*</label>
              <input
                type="password"
                class="form-control"
                id="contrasena"
                required
              />
            </div>
            <div class="mb-3">
              <label for="rol" class="form-label">Rol</label>
              <select class="form-select" id="rol">
                <option value="user">Usuario normal</option>
                <option value="admin">Administrador</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary">Registrar</button>
          </form>
          <div id="alert" class="alert mt-3" role="alert"></div>
        </div>
      </div>

      <!-- Tabla de usuarios -->
      <div class="card">
        <div class="card-body">
          <h2 class="mb-3">Usuarios Registrados</h2>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Matrícula</th>
                  <th>Nombre</th>
                  <th>Rol</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <!-- Los usuarios se cargarán aquí -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Tu código JavaScript -->
    <script>
      // ... el código JavaScript que proporcionaste ...
      document.addEventListener("DOMContentLoaded", function () {
        // Cargar usuarios al iniciar
        loadUsers();

        // Manejar el envío del formulario
        document
          .getElementById("userForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            registerUser();
          });
      });

      function registerUser() {
        const matricula = document.getElementById("matricula").value;
        const nombre = document.getElementById("nombre").value;
        const contrasena = document.getElementById("contrasena").value;
        const rol = document.getElementById("rol").value;

        const userData = {
          matricula: matricula,
          nombre: nombre,
          contrasena: contrasena,
          rol: rol,
        };

        fetch("https://salt-utsv-production.up.railway.app/api/usuarios", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(userData),
        })
          .then((response) => {
            if (!response.ok) {
              return response.json().then((err) => {
                throw new Error(
                  err.error || "Error en la respuesta del servidor"
                );
              });
            }
            return response.json();
          })
          .then((data) => {
            showAlert("Usuario registrado correctamente", "success");
            document.getElementById("userForm").reset();
            loadUsers(); // Recargar la lista de usuarios
          })
          .catch((error) => {
            console.error("Error:", error);
            showAlert(
              "Error al registrar el usuario: " + error.message,
              "danger"
            );
          });
      }

      function loadUsers() {
        fetch("https://salt-utsv-production.up.railway.app/api/usuarios")
          .then((response) => {
            if (!response.ok) {
              throw new Error("Error al cargar los usuarios");
            }
            return response.json();
          })
          .then((data) => {
            const tableBody = document.getElementById("usersTableBody");
            tableBody.innerHTML = "";

            // Asegúrate de que data.data es el array de usuarios (depende de tu estructura de respuesta)
            const users = data.data || data;

            users.forEach((user) => {
              const row = document.createElement("tr");

              row.innerHTML = `
                            <td>${user.idusuario}</td>
                            <td>${user.matricula || "N/A"}</td>
                            <td>${user.nombre || "N/A"}</td>
                            <td><span class="badge ${
                              user.rol === "admin"
                                ? "badge-admin"
                                : "badge-user"
                            }">${user.rol}</span></td>
                        `;

              tableBody.appendChild(row);
            });
          })
          .catch((error) => {
            console.error("Error:", error);
            showAlert(
              "Error al cargar los usuarios: " + error.message,
              "danger"
            );
          });
      }

      function showAlert(message, type) {
        const alertDiv = document.getElementById("alert");
        alertDiv.textContent = message;
        alertDiv.className = `alert alert-${type}`;
        alertDiv.style.display = "block";

        // Ocultar la alerta después de 5 segundos
        setTimeout(() => {
          alertDiv.style.display = "none";
        }, 5000);
      }
    </script>

    <!-- Bootstrap JS (opcional) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
